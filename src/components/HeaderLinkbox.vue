<template>
  <div class="w-full card-light-shadow rounded-3xl flex flex-row flex-nowrap">
    <div class="flex items-center px-2">
      <svg
        class="handle cursor-grab"
        width="14"
        height="16"
        viewBox="0 0 14 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M6.75 2.5C6.55109 2.5 6.36032 2.42098 6.21967 2.28033C6.07902 2.13968 6 1.94891 6 1.75C6 1.55109 6.07902 1.36032 6.21967 1.21967C6.36032 1.07902 6.55109 1 6.75 1C6.94891 1 7.13968 1.07902 7.28033 1.21967C7.42098 1.36032 7.5 1.55109 7.5 1.75C7.5 1.94891 7.42098 2.13968 7.28033 2.28033C7.13968 2.42098 6.94891 2.5 6.75 2.5ZM6.75 8.5C6.55109 8.5 6.36032 8.42098 6.21967 8.28033C6.07902 8.13968 6 7.94891 6 7.75C6 7.55109 6.07902 7.36032 6.21967 7.21967C6.36032 7.07902 6.55109 7 6.75 7C6.94891 7 7.13968 7.07902 7.28033 7.21967C7.42098 7.36032 7.5 7.55109 7.5 7.75C7.5 7.94891 7.42098 8.13968 7.28033 8.28033C7.13968 8.42098 6.94891 8.5 6.75 8.5ZM6.75 14.5C6.55109 14.5 6.36032 14.421 6.21967 14.2803C6.07902 14.1397 6 13.9489 6 13.75C6 13.5511 6.07902 13.3603 6.21967 13.2197C6.36032 13.079 6.55109 13 6.75 13C6.94891 13 7.13968 13.079 7.28033 13.2197C7.42098 13.3603 7.5 13.5511 7.5 13.75C7.5 13.9489 7.42098 14.1397 7.28033 14.2803C7.13968 14.421 6.94891 14.5 6.75 14.5Z"
          stroke="black"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M1.75 2.5C1.55109 2.5 1.36032 2.42098 1.21967 2.28033C1.07902 2.13968 1 1.94891 1 1.75C1 1.55109 1.07902 1.36032 1.21967 1.21967C1.36032 1.07902 1.55109 1 1.75 1C1.94891 1 2.13968 1.07902 2.28033 1.21967C2.42098 1.36032 2.5 1.55109 2.5 1.75C2.5 1.94891 2.42098 2.13968 2.28033 2.28033C2.13968 2.42098 1.94891 2.5 1.75 2.5ZM1.75 8.5C1.55109 8.5 1.36032 8.42098 1.21967 8.28033C1.07902 8.13968 1 7.94891 1 7.75C1 7.55109 1.07902 7.36032 1.21967 7.21967C1.36032 7.07902 1.55109 7 1.75 7C1.94891 7 2.13968 7.07902 2.28033 7.21967C2.42098 7.36032 2.5 7.55109 2.5 7.75C2.5 7.94891 2.42098 8.13968 2.28033 8.28033C2.13968 8.42098 1.94891 8.5 1.75 8.5ZM1.75 14.5C1.55109 14.5 1.36032 14.421 1.21967 14.2803C1.07902 14.1397 1 13.9489 1 13.75C1 13.5511 1.07902 13.3603 1.21967 13.2197C1.36032 13.079 1.55109 13 1.75 13C1.94891 13 2.13968 13.079 2.28033 13.2197C2.42098 13.3603 2.5 13.5511 2.5 13.75C2.5 13.9489 2.42098 14.1397 2.28033 14.2803C2.13968 14.421 1.94891 14.5 1.75 14.5Z"
          stroke="black"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M11.75 2.5C11.5511 2.5 11.3603 2.42098 11.2197 2.28033C11.079 2.13968 11 1.94891 11 1.75C11 1.55109 11.079 1.36032 11.2197 1.21967C11.3603 1.07902 11.5511 1 11.75 1C11.9489 1 12.1397 1.07902 12.2803 1.21967C12.421 1.36032 12.5 1.55109 12.5 1.75C12.5 1.94891 12.421 2.13968 12.2803 2.28033C12.1397 2.42098 11.9489 2.5 11.75 2.5ZM11.75 8.5C11.5511 8.5 11.3603 8.42098 11.2197 8.28033C11.079 8.13968 11 7.94891 11 7.75C11 7.55109 11.079 7.36032 11.2197 7.21967C11.3603 7.07902 11.5511 7 11.75 7C11.9489 7 12.1397 7.07902 12.2803 7.21967C12.421 7.36032 12.5 7.55109 12.5 7.75C12.5 7.94891 12.421 8.13968 12.2803 8.28033C12.1397 8.42098 11.9489 8.5 11.75 8.5ZM11.75 14.5C11.5511 14.5 11.3603 14.421 11.2197 14.2803C11.079 14.1397 11 13.9489 11 13.75C11 13.5511 11.079 13.3603 11.2197 13.2197C11.3603 13.079 11.5511 13 11.75 13C11.9489 13 12.1397 13.079 12.2803 13.2197C12.421 13.3603 12.5 13.5511 12.5 13.75C12.5 13.9489 12.421 14.1397 12.2803 14.2803C12.1397 14.421 11.9489 14.5 11.75 14.5Z"
          stroke="black"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </div>
    <div class="w-full">
      <div class="flex justify-between items-center w-full pt-2 pr-2">
        <div>
          <div class="">
            <span
              class="px-1 py-[1px] rounded-[1rem] bg-amber-300/20 text-xs font-medium text-amber-600/70"
              >Header</span
            >
          </div>
        </div>
        <div class="">
          <div>
            <label
              class="relative inline-flex items-center mb-5 cursor-pointer"
            >
              <input
                type="checkbox"
                v-model="isActive"
                @change="updateLink"
                value="true"
                class="sr-only peer"
              />
              <div
                class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"
              ></div>
            </label>
          </div>
        </div>
      </div>
      <div :id="`LinkBox${link.id}`" class="w-full">
        <div id="MainLinkBoxSection" class="relative md:px-8 pt-2 pb-14">
          <div class="w-full flex items-center justify-center">
            <!-- <label for="Title" class="text-sm leading-6 text-gray-600"
                  >Title</label
                > -->
            <div class="relative w-min mb-0.5 font-medium">
              <input
                type="text"
                v-model="name"
                @change="updateLink"
                id="input-group-1"
                class="inputs text-center bg-transparent focus:bg-gray-50 focus:border-opacity-0 focus:border-gray-100 text-gray-900 text-sm rounded-lg focus:ring-blue-50 block pl- p-2.5"
                placeholder="Title"
              />
              <div
                class="absolute inset-y-0 left-0 flex items-center pr-3.5 pointer-events-none"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                  class="w-4 h-4 text-gray-500"
                >
                  <path
                    d="M21.731 2.269a2.625 2.625 0 00-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 000-3.712zM19.513 8.199l-3.712-3.712-12.15 12.15a5.25 5.25 0 00-1.32 2.214l-.8 2.685a.75.75 0 00.933.933l2.685-.8a5.25 5.25 0 002.214-1.32L19.513 8.2z"
                  />
                </svg>

                <!-- <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                      class="w-4 h-4 text-gray-500"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125"
                      />
                    </svg> -->
              </div>
            </div>
          </div>

          <div
            class="absolute z-10 inset-x-0 bottom-0 flex items-center rounded-[10px] p-[0.375rem]"
          >
            <div class="flex flex-col items-center justify-center w-full">
              <div class="bgfilterblur p-1 rounded-[2.5rem]">
                <button
                  @click="isUpdateHeaderAlignment = !isUpdateHeaderAlignment"
                  class="cursor-pointer pointer-events-auto rounded-[4rem] outline-none mr-2 !p-1.5 text-black"
                  :class="
                    isUpdateHeaderAlignment
                      ? ' bg-white text-purple-700 shadow-lg'
                      : ''
                  "
                  :color="isUpdateHeaderAlignment ? '#FFFFFF' : '#676B5F'"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-5 h-5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M2.25 7.125C2.25 6.504 2.754 6 3.375 6h6c.621 0 1.125.504 1.125 1.125v3.75c0 .621-.504 1.125-1.125 1.125h-6a1.125 1.125 0 01-1.125-1.125v-3.75zM14.25 8.625c0-.621.504-1.125 1.125-1.125h5.25c.621 0 1.125.504 1.125 1.125v8.25c0 .621-.504 1.125-1.125 1.125h-5.25a1.125 1.125 0 01-1.125-1.125v-8.25zM3.75 16.125c0-.621.504-1.125 1.125-1.125h5.25c.621 0 1.125.504 1.125 1.125v2.25c0 .621-.504 1.125-1.125 1.125h-5.25a1.125 1.125 0 01-1.125-1.125v-2.25z"
                    />
                  </svg>
                </button>

                <button
                  @click="
                    isDelete = true;
                    isEmbbedLink = false;
                  "
                  class="cursor-pointer pointer-events-auto rounded-[4rem] outline-none !p-1.5 text-black"
                  :class="isDelete ? ' bg-white text-purple-700 shadow-lg' : ''"
                  :color="isDelete ? '#FFFFFF' : '#676B5F'"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-5 h-5 cursor-pointer"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div
          id="FooterLinkDeleteSection"
          class="overflow-hidden"
          :class="[
            {
              'max-h-[180px] transition-all duration-300 ease-in mt-10':
                isDelete,
            },
            {
              'max-h-0 transition-all duration-200 ease-out': !isDelete,
            },
          ]"
        >
          <button
            @click="isDelete = false"
            class="relative w-full bg-[#DFE2D9] py-1.5"
          >
            <Icon
              name="mdi:close"
              class="absolute right-1 top-[6px] cursor-pointer"
              size="20"
              color="#45494A"
            />
            <div class="text-center text-sm font-bold text-gray-200">
              Delete
            </div>
          </button>

          <div class="flex items-center justify-center pt-3 text-gray-200">
            Delete this forever?
          </div>

          <div class="w-full px-4 py-3">
            <div class="flex items-center gap-2 w-full">
              <button
                @click="deleteLink()"
                class="flex items-center border justify-center w-full py-3 rounded-full text-gray-200 hover:text-gray-900 font-semibold hover:bg-gray-100"
              >
                Remove
              </button>
            </div>
          </div>
        </div>

        <div
          id="FooterLinkLayoutSection"
          class="overflow-hidden"
          :class="[
            {
              'max-h-[480px] transition-all duration-300 ease-in mt-10':
                isUpdateHeaderAlignment,
            },
            {
              'max-h-0 transition-all duration-200 ease-out':
                !isUpdateHeaderAlignment,
            },
          ]"
        >
          <div class="relative w-full bg-[#DFE2D9] py-1.5">
            <svg
              @click="isUpdateHeaderAlignment = false"
              color="#45494A"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="absolute right-1 top-[6px] cursor-pointer w-5 h-5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>

            <div class="text-center text-sm font-bold text-[#45494A]">
              More options
            </div>
          </div>

          <div class="w-full flex flex-row px-4 py-5">
            <form @submit.prevent="updateCategory()">
              <!-- text position -->
              <div class="mt-10">
                <RadioGroup
                  v-model="selectedTextAlign"
                  @update:modelValue="(value) => dataChange()"
                  class="mt-4"
                >
                  <RadioGroupLabel class="sr-only"
                    >Choose a size</RadioGroupLabel
                  >
                  <div class="flex flex-row flex-wrap">
                    <RadioGroupOption
                      as="template"
                      v-for="position in textAlign"
                      :key="position.name"
                      :value="position.name"
                      v-slot="{ active, checked }"
                      class="min-w-[80px]"
                    >
                      <div
                        :class="[
                          active ? 'bg-purple-700 text-white' : 'text-gray-950',
                          checked
                            ? 'bg-purple-700 text-white'
                            : 'border-transparent',
                          'group relative flex items-center justify-center  w-auto mb-3 rounded-full  py-1 px-0.5 text-sm font-medium  focus:outline-none sm:flex-1',
                        ]"
                      >
                        <span v-html="position.icon" />

                        <span
                          :class="[
                            active ? '' : '',
                            checked ? '' : 'border-transparent',
                            'pointer-events-none absolute -inset-px rounded-full',
                          ]"
                          aria-hidden="true"
                        />
                      </div>
                    </RadioGroupOption>
                  </div>
                </RadioGroup>
              </div>

              <!-- <button
                        type="submit"
                        class="mt-6 flex w-full items-center justify-center rounded-md border border-transparent bg-indigo-600 px-8 py-3 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    >
                        Save
                    </button> -->
            </form>
          </div>
        </div>

        <CropperModal
          v-if="openCropper"
          :linkId="link.id"
          @data="data = $event"
          @close="openCropper = false"
        />
      </div>
    </div>
  </div>
</template>

<script setup>
import {
  TransitionRoot,
  TransitionChild,
  Dialog,
  DialogPanel,
  DialogTitle,
  RadioGroup,
  RadioGroupLabel,
  RadioGroupOption,
} from "@headlessui/vue";
import CropperModal from "./CropperModal.vue";
import debounce from "lodash/debounce";
import { watch, ref, onMounted, toRefs } from "vue";
import { useStore } from "vuex";
const store = useStore();

const props = defineProps({
  link: Object,
  selectedId: { type: Number, default: 0 },
  selectedStr: { type: String, default: "" },
});
const { link, selectedId, selectedStr } = toRefs(props);
const model = ref(JSON.parse(JSON.stringify(props.link)));

const emit = defineEmits(["updatedInput"]);

let name = ref("");
let url = ref("");

let data = ref(null);
let isActive = ref(false);
let isDelete = ref(false);
let openCropper = ref(false);
let isUploadImage = ref(false);
let isUpdateHeaderAlignment = ref(false);
let errors = null;

const textAlign = [
  {
    name: "left",
    icon: `
        <svg
                            class="w-5 h-5"
                            width="18"
                            height="12"
                            viewBox="0 0 18 12"
                            fill="none"
                            stroke="currentColor"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                d="M0.75 0.75H17.25M0.75 6H9M0.75 11.25H17.25"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
      `,
  },
  {
    name: "center",

    icon: `
        <svg
                            class=""
                            width="18"
                            height="12"
                            viewBox="0 0 18 12"
                            fill="none"
                            stroke="currentColor"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                d="M0.75 0.75H17.25M5 6H13.25M0.75 11.25H17.25"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
      `,
  },
  {
    name: "right",

    icon: `
        <svg
                            class=""
                            width="18"
                            height="12"
                            viewBox="0 0 18 12"
                            fill="none"
                            stroke="currentColor"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                d="M17.25 11.25L0.75 11.25M17.25 6L9 6M17.25 0.75L0.75 0.75"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
      `,
  },
];

const selectedTextAlign = ref(textAlign[0]);

onMounted(() => {
  name.value = link.value.name;
  url.value = link.value.url;
  isActive.value = link.value.active ? true : false;
  selectedTextAlign.value.name = props.link.data?.textAlignment || "";
});

const updateLink = async () => {
  console.log(name.value);
  try {
    await store.dispatch("updateLink", {
      id: link.value.id,
      name: name.value,
      deascription: null,
      url: url.value,
      active: isActive.value,
    });
    await store.dispatch("getAllLinks");
  } catch (error) {
    console.log(error);
    errors.value = error.response.data.errors;
  }
};

const dataChange = async () => {
  model.value.data = {
    textAlignment: selectedTextAlign.value,
  };
  console.log(model.value.data);

  try {
    await store.dispatch("updateStartupData", model.value);
    await store.dispatch("getAllLinks");
  } catch (error) {
    console.log(error);
  }
};

const updateLinkImage = async () => {
  try {
    await store.dispatch("updateLinkImage", data.value);
    await store.dispatch("getAllLinks");
    setTimeout(() => (openCropper.value = false), 300);
  } catch (error) {
    console.log(error);
  }
};

const deleteLink = async () => {
  let res = confirm("Are you sure you want to delete this link?");
  try {
    if (res) {
      await store.dispatch("deleteLink", link.value.id);
      await store.dispatch("getAllLinks");
    }
  } catch (error) {
    console.log(error);
  }
};

watch(
  () => store.state.user.updatedLinkId.value,
  (val) => {
    if (!val) {
      emit("updatedInput", { id: 0, str: "" });
    }
  }
);

watch(
  () => data.value,
  async () => await updateLinkImage()
);
</script>
